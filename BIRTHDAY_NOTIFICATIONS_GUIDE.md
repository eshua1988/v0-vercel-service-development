# Руководство по настройке уведомлений о днях рождения

## Проблема

На скриншоте видно, что пользователь установил время уведомления 13:53 для именинника (дата рождения 21.12.2024), но push-уведомления не приходят ни через браузер, ни через Firebase.

## Причины проблемы

### 1. Разрешения браузера заблокированы

Из debug логов видно:
```
[v0] Notifications not supported or not granted
[v0] Current notification permission: denied
[v0] Notifications blocked by user, skipping Firebase initialization
```

**Решение:** Разрешить уведомления в браузере

#### Android Chrome:
1. Нажмите на значок замка/информации слева от адресной строки
2. Найдите "Уведомления" (Notifications)
3. Выберите "Разрешить" (Allow)
4. Перезагрузите страницу

#### Альтернативный способ:
1. Откройте Настройки Chrome (три точки → Настройки)
2. Перейдите в "Настройки сайтов" → "Уведомления"
3. Найдите ваш сайт и переключите на "Разрешить"

### 2. Firebase Cloud Messaging не настроен

Для получения push-уведомлений на телефон через Firebase необходимо:

**На клиенте (телефоне):**
1. Разрешить уведомления в браузере (см. выше)
2. Приложение автоматически получит FCM токен
3. Токен сохранится в таблице `fcm_tokens` в базе данных

**На сервере:**
1. Убедитесь что переменная окружения `FIREBASE_SERVICE_ACCOUNT_KEY` настроена
2. Она должна содержать JSON ключ сервисного аккаунта Firebase
3. Без этого ключа сервер не может отправлять уведомления через Firebase

### 3. Система уведомлений

Приложение использует две системы для отправки уведомлений:

#### A. Клиентская (браузерная)
- Компонент `NotificationManager` проверяет дни рождения каждую минуту
- Работает только если браузер открыт и разрешения даны
- **Ограничение:** Не работает если разрешения заблокированы

#### B. Серверная (Firebase Cloud Messaging)
- Vercel Cron запускает `/api/cron/check-birthdays` каждую минуту
- Отправляет уведомления через Firebase Admin SDK
- **Преимущество:** Работает даже если браузер закрыт
- **Требование:** Нужен FIREBASE_SERVICE_ACCOUNT_KEY

## Как проверить что все работает

### Шаг 1: Разрешить уведомления

1. Откройте приложение на телефоне
2. Разрешите уведомления в браузере (см. инструкцию выше)
3. Перезагрузите страницу
4. Вы увидите сообщение "Уведомления разрешены" с зеленым статусом

### Шаг 2: Проверить FCM токен

1. Откройте боковое меню → Настройки
2. Прокрутите до секции "Firebase Cloud Messaging"
3. Вы должны увидеть ваш FCM токен (длинная строка)
4. Если токена нет - уведомления не работают

### Шаг 3: Отправить тестовое уведомление

1. В настройках нажмите кнопку "Отправить тестовое уведомление"
2. Если все настроено правильно, вы получите push-уведомление
3. Если ошибка - проверьте консоль браузера на детали

### Шаг 4: Проверить настройки именинника

1. Откройте карточку именинника
2. Убедитесь что:
   - Дата рождения правильная (21.12.2024)
   - Время уведомления установлено (13:53)
   - Переключатель "Включить оповещение" включен ✓
3. Нажмите "Сохранить"

### Шаг 5: Дождаться времени уведомления

Уведомление придет:
- Точно в указанное время (13:53:00)
- В день рождения (21 декабря)
- Если все настройки правильные

## Формат времени

**Важно:** Время в базе данных хранится в формате `HH:MM:SS`
- Правильно: `13:53:00`
- Неправильно: `13:53` (нужны секунды)

Приложение автоматически добавляет `:00` к времени, но убедитесь что в базе данных сохранено правильно.

## Проверка в базе данных

Вы можете проверить сохраненные данные в Supabase:

```sql
-- Проверить настройки уведомлений
SELECT * FROM settings WHERE key = 'notifications_enabled';

-- Проверить FCM токены
SELECT * FROM fcm_tokens WHERE user_id = 'YOUR_USER_ID';

-- Проверить именинников с включенными уведомлениями
SELECT 
  first_name, 
  last_name, 
  birth_date, 
  notification_time, 
  notification_enabled 
FROM birthdays 
WHERE notification_enabled = true;
```

## Настройка Firebase Service Account

Для отправки уведомлений через Firebase нужен ключ сервисного аккаунта:

1. Откройте [Firebase Console](https://console.firebase.google.com/)
2. Выберите ваш проект
3. Перейдите в Project Settings → Service Accounts
4. Нажмите "Generate new private key"
5. Скачайте JSON файл
6. Скопируйте весь JSON в переменную окружения `FIREBASE_SERVICE_ACCOUNT_KEY`

В Vercel:
1. Project Settings → Environment Variables
2. Добавьте `FIREBASE_SERVICE_ACCOUNT_KEY`
3. Вставьте весь JSON (начинается с `{`)
4. Сохраните и передеплойте приложение

## Логирование и отладка

Cron job логирует все операции:

```
[v0] Cron: Checking birthdays at: 13:53:00 Date: 2024-12-21...
[v0] Cron: Found 84 birthdays with notifications enabled
[v0] Cron: Checking 22222 1111122
[v0] Cron: Sending notification for: 22222 1111122 to 1 devices
[v0] Cron: FCM sent successfully
```

Проверяйте логи в Vercel Dashboard → Deployments → Functions → Logs

## Частые проблемы

### "Уведомления заблокированы"
- **Причина:** Пользователь отклонил разрешение
- **Решение:** Разрешить в настройках браузера

### "FCM токен не появляется"
- **Причина:** Firebase переменные не настроены или разрешения заблокированы
- **Решение:** Проверить переменные окружения и разрешения

### "Тестовое уведомление не работает"
- **Причина:** FIREBASE_SERVICE_ACCOUNT_KEY не настроен
- **Решение:** Добавить ключ в переменные окружения

### "Уведомление не приходит в указанное время"
- **Причина:** Cron не запущен или время не совпадает
- **Решение:** Проверить что cron настроен на каждую минуту и время в формате HH:MM:SS

### "Время сохраняется но не работает"
- **Причина:** В базе данных может быть формат без секунд
- **Решение:** Убедитесь что время сохранено как `13:53:00` (с секундами)

## Итоговый чеклист

- [ ] Разрешены уведомления в браузере
- [ ] FCM токен появился в настройках
- [ ] FIREBASE_SERVICE_ACCOUNT_KEY настроен в Vercel
- [ ] Cron job запускается каждую минуту
- [ ] Именинник имеет правильную дату рождения
- [ ] Время уведомления установлено в формате HH:MM:SS
- [ ] Переключатель "Включить оповещение" включен
- [ ] Глобальные уведомления включены в настройках

Если все пункты выполнены - уведомления будут работать!
