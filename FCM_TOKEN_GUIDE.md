# Руководство по получению FCM токена для push-уведомлений

## Что такое FCM токен?

FCM (Firebase Cloud Messaging) токен - это уникальный идентификатор вашего устройства/браузера, который используется для отправки push-уведомлений. Этот токен генерируется автоматически Firebase SDK при первом запросе разрешения на уведомления.

## Современный FCM API

Наше приложение использует современный FCM API вместо устаревшего Instance ID API:

### Что мы используем:
- ✅ `getToken()` из `firebase/messaging` - получение регистрационного токена
- ✅ Автоматический мониторинг обновлений токена
- ✅ Service Worker для фоновых уведомлений

### Что устарело (не используем):
- ❌ Instance ID API
- ❌ `firebase.messaging().getToken()` (старая версия)

## Как получить FCM токен

### Шаг 1: Разрешите уведомления в браузере

**Android Chrome:**
1. Откройте приложение в Chrome
2. Нажмите на иконку замка слева от URL
3. Найдите "Уведомления"
4. Выберите "Разрешить"

**Android Firefox:**
1. Откройте приложение в Firefox
2. Нажмите на иконку настроек сайта
3. Разрешите уведомления

**Desktop Chrome/Edge:**
1. Нажмите на иконку замка в адресной строке
2. Настройки сайта → Уведомления → Разрешить

### Шаг 2: Перезагрузите страницу

После разрешения уведомлений обновите страницу (F5 или свайп вниз на мобильном).

### Шаг 3: Проверьте токен в настройках

1. Откройте боковое меню (☰)
2. Перейдите в "Настройки"
3. Прокрутите до секции "Firebase Cloud Messaging"
4. Вы увидите ваш FCM токен
5. Нажмите кнопку "Скопировать токен"

## Мониторинг обновлений токена

Приложение автоматически отслеживает изменения FCM токена в следующих случаях:

1. **Первый запуск приложения** - генерируется новый токен
2. **Восстановление на новом устройстве** - токен меняется
3. **Переустановка приложения** - генерируется новый токен
4. **Очистка данных приложения** - требуется новый токен
5. **Периодическое обновление** - проверка каждые 24 часа

Когда токен обновляется, вы получите уведомление и новый токен автоматически сохранится в базе данных.

## Отправка тестового уведомления

После получения токена:

1. В настройках нажмите "Отправить тестовое уведомление"
2. Если все настроено правильно, вы получите push-уведомление
3. Проверьте консоль браузера для отладочной информации

## Проблемы и решения

### "Notifications not supported or not granted"
**Причина:** Разрешения на уведомления не даны  
**Решение:** Следуйте Шагу 1 выше и разрешите уведомления

### "No FCM registration token available"
**Причина:** Service Worker не зарегистрирован или Firebase не настроен  
**Решение:** 
- Проверьте консоль на ошибки
- Убедитесь что все Firebase переменные настроены
- Проверьте что `firebase-messaging-sw.js` доступен в `/public`

### "Failed to register service worker"
**Причина:** Service Worker не может быть зарегистрирован  
**Решение:**
- Используйте HTTPS (HTTP не поддерживается для SW)
- Проверьте путь к service worker файлу
- Очистите кеш браузера

### Токен не отображается в настройках
**Причина:** Разрешения заблокированы или Firebase не инициализирован  
**Решение:**
1. Проверьте статус разрешений (должен быть "granted")
2. Откройте консоль браузера (F12)
3. Ищите ошибки с префиксом "[v0]"
4. Убедитесь что VAPID ключ настроен на сервере

## Требования

Для работы FCM токенов требуются следующие переменные окружения:

```env
# Публичные (клиентские)
NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_app_id

# Серверные (для отправки уведомлений)
FIREBASE_SERVICE_ACCOUNT_KEY={"type":"service_account",...}
```

## Дополнительные ресурсы

- [Firebase Cloud Messaging Documentation](https://firebase.google.com/docs/cloud-messaging)
- [Web Push Notifications Guide](https://web.dev/push-notifications-overview/)
- [Service Workers API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
